<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="oanc.github.io : GitHub repository for the American National Corpus.">

    <link rel="stylesheet" type="text/css" media="screen" href="/css/slate.css">
    <link rel="stylesheet" type="text/css" media="screen" href="/css/lappsgrid.css"/>
     
	<script type="text/javascript"
		src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
	</script>
		<script type="text/javascript">
		MathJax.Hub.Config({
			jax: ["input/TeX", "output/HTML-CSS"],
            tex2jax: {
                inlineMath: [ ['%','%'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                processEscapes: false
            },
        });
    </script>	

    <title>Galaxy</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <!-- <a id="forkme_banner" href="https://github.com/lapps">View on GitHub</a> -->
		  <a id="forkme_banner" href="https://github.com/lapps/lapps.github.io/edit/master/technical/galaxy.md">Edit this page on GitHub</a>.
		  
          <h1 id="project_title">The LAPPS Grid Wiki</h1>
          <h2 id="project_tagline">A framework for interoperable NLP web services.</h2>

        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">


	<p>This page describes setting up a production LAPPS Grid Galaxy instance on a fresh Ubuntu 14.04 LTS instance. The easiest way to run a LAPPS Grid Galaxy instance is to use one of the Docker images available from the <a href="https://hub.docker.com">Docker Hub</a>.  However at times it is required to install and run a Galaxy instance from the sources in the GitHub repository.</p>

<h1 id="tldr">TL;DR</h1>

<p>On a fresh Ubuntu install run:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$&gt; </span>curl -sSL http://downloads.lappsgrid.org/scripts/galaxy-setup.sh | sh
<span class="gp">$&gt; </span><span class="nb">cd</span> /home/galaxy/galaxy
<span class="gp">$&gt; </span><span class="nv">HOME</span><span class="o">=</span>/home/galaxy sudo -u galaxy ./run.sh
</code></pre>
</div>

<h1 id="the-long-version">The Long Version</h1>

<h3 id="prerequisites">Prerequisites</h3>

<p>To run Galaxy and all of the LAPPS Grid tools the following packages are required:</p>

<ol>
  <li>Java</li>
  <li>PostgreSQL</li>
  <li>LSD</li>
  <li>Galaxy</li>
</ol>

<p>Install scripts are available from <a href="http://downloads.lappsgrid.org/scripts">http://downloads.lappsgrid.org/scripts</a> to perform all of the above tasks.</p>

<h3 id="common-packages">Common Packages</h3>

<p>Install the common utilities, Postgres, Java, and LSD packages.  The database will be configured below:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$&gt; </span>curl -sSL http://downloads.lappsgrid.org/scripts/install-common.sh | sh
<span class="gp">$&gt; </span>curl -sSL http://downloads.lappsgrid.org/scripts/install-postgres.sh | sh
<span class="gp">$&gt; </span>curl -sSL http://downloads.lappsgrid.org/scripts/install-java.sh | sh
<span class="gp">$&gt; </span>curl -sSL http://downloads.lappsgrid.org/scripts/install-lsd.sh | sh
</code></pre>
</div>

<p><strong>NOTE</strong> The <em>install-common.sh</em> script may display some error messages when used on a <a href="/technical/jetstream.html">Jetstream</a> instance.  This seems to be due to Jetstream/OpenStack not allowing some OS packages (i.e. firmware) to be updated.  It should be safe to ignore these errors.</p>

<h3 id="galaxy-user">Galaxy User</h3>

<p>Create a system account for running galaxy.  We want to create a system account as the <em>galaxy</em> user should not be able to login to the system.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$&gt; </span>adduser galaxy --system --group
</code></pre>
</div>

<h3 id="selecting-a-secure-password">Selecting a Secure Password</h3>

<p>Since both both the database setup script (see below) and the <em>galaxy.ini</em> file are available from publicly accessible repositories we will need to change the passwords stored in these files.  Currently both files use <em>__DB_PASSWORD__</em> as the database password to make it easier to update both via a <code class="highlighter-rouge">sed</code> command.</p>

<p>For production use it is <strong>highly recommended</strong> to use a strong password.  The web service <a href="http://grid.anc.org:9080/password">http://grid.anc.org:9080/password</a> can be used to generate cryptographically strong random passwords of any length.  We can use this web service to generate a password and then store it someplace secure on the server (<em>/root</em> is a good location) in case an administrator needs to connect to the database later.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$&gt; </span>curl -sSL http://grid.anc.org:9080/password?length<span class="o">=</span>24 &gt; /root/postgres.passwd
<span class="gp">$&gt; </span><span class="nb">export </span><span class="nv">PASSWORD</span><span class="o">=</span><span class="sb">`</span>cat /root/postgres.passwd<span class="sb">`</span>
</code></pre>
</div>

<p>We store the generated password in the environment variable <strong>$PASSWORD</strong> to make it easier to use below.</p>

<h3 id="galaxy">Galaxy</h3>

<p>The LAPPS Grid Galaxy instance it stored in two repositories on GitHub:</p>

<ol>
  <li><strong>https://github.com/lappsgrid-incubator/Galaxy.git</strong><br />
This is a fork of the <a href="https://github.com/galaxyproject/galaxy">main Galaxy repository</a>. We try to leave this repository alone as much as possible, but currently it contains several modified JavaScript files for the Galaxy client to configure the masthead and allow tools to be connected in the workflow editor if a converter exists (e.g. connecting a GATE tool to a tool that expects LIF).</li>
  <li><strong>https://github.com/lappsgrid-incubator/GalaxyMods.git</strong><br />
Currently this repository contains the datatype definitions, tool wrappers, and other files that can be stored externally and then configured in the <em>galaxy.ini</em> file. A sample <em>galaxy.ini</em> file is included as a starting point.</li>
</ol>

<p>When the repositories have been checked out to a local system it is important to ensure you are working from the correct branch.</p>

<table>
  <thead>
    <tr>
      <th>Repository</th>
      <th>Branch</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Galaxy.git</td>
      <td>lapps</td>
    </tr>
    <tr>
      <td>GalaxyMods.git</td>
      <td>master</td>
    </tr>
  </tbody>
</table>

<p>Clone the Git repositories into <em>/home/galaxy</em>.  The default <em>galaxy.ini</em> configuration file assumes that the Galaxy configuration files (tool_conf.xml, datatypes_conf.xml etc.) can all be found in <em>/home/galaxy/mods</em>. If the Galaxy repository is checked out to a location other that <em>/home/galaxy</em> then the <em>galaxy.ini</em> file will need to be updated accordingly.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$&gt; </span><span class="nb">cd</span> /home/galaxy
<span class="gp">$&gt; </span><span class="nv">HOME</span><span class="o">=</span>/home/galaxy sudo -u galaxy git clone http://github.com/lappsgrid-incubator/Galaxy.git galaxy
<span class="gp">$&gt; </span><span class="nv">HOME</span><span class="o">=</span>/home/galaxy sudo -u galaxy git clone http://github.com/lappsgrid-incubator/GalaxyMods.git mods
<span class="gp">$&gt; </span><span class="nb">cd </span>galaxy
<span class="gp">$&gt; </span>git checout lapps
<span class="gp">$&gt; </span><span class="nb">cd</span> -
</code></pre>
</div>

<p><strong>NOTE:</strong> We must set <code class="highlighter-rouge">HOME=/home/galaxy</code> when using <code class="highlighter-rouge">sudo -u</code> as sudo does not update the environment and will leave <code class="highlighter-rouge">HOME=/root</code>, which the <em>galaxy</em> user can not read/write.</p>

<h4 id="securing-galaxy">Securing Galaxy</h4>

<p>There are four values that have been parameterized in the default <em>galaxy.ini</em> file that will need to be replaced before Galaxy can be started.  They are:</p>

<ul>
  <li><strong>__PORT__</strong><br />
The port that Galaxy will listen on.</li>
  <li><strong>__INSTALL_DIR__</strong><br />
The directory containing the two GitHub repositories.</li>
  <li><strong>__DB_PASSWORD__</strong><br />
The password to access the <em>galaxy</em> database.</li>
  <li><strong>__ID_SECRET__</strong><br />
Galaxy’s “secret” that it uses to encrypt sensitive data.</li>
</ul>

<p>You can either edit the <em>galaxy.ini</em> directly and replace all occurrences of the above or you can use the <a href="http://downloads.lappsgrid.org/scripts/patch-galaxy-ini.sh">http://downloads.lappsgrid.org/scripts/patch-galaxy-ini.sh</a> script to replace the occurrences for you.</p>

<p>The <em>patch-galaxy-ini.sh</em> script accepts one parameter: the path to the directory containing the <em>galaxy</em> and <em>mods</em> directories; <em>/home/galaxy</em> in this case.  The script will also use the environment variables <strong>PORT</strong>, <strong>PASSWORD</strong>, and <strong>SECRET</strong> if defined.  The <strong>PORT</strong> will default to 8000 if not defined, and the <strong>PASSWORD</strong> and <strong>SECRET</strong> will be generated with the password web service if not defined.  Recall that we did define <strong>PASSWORD</strong> above.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$&gt; </span>wget http://downloads.lappsgrid.org/scripts/patch-galaxy-ini.sh
<span class="gp">$&gt; </span>chmod +x patch-galaxy-ini.sh
<span class="gp">$&gt; </span><span class="nv">PORT</span><span class="o">=</span>80 ./patch-galaxy-ini.sh /home/galaxy
</code></pre>
</div>

<h3 id="database-setup">Database Setup</h3>

<p>Use the script <a href="http://downloads.lappsgrid.org/scripts/db-setup.sql">http://downloads.lappsgrid.org/scripts/db-setup.sql</a> to configure the Postgres database.  Galaxy will create and populate the tables it needs when it starts for the first time, we just need to create the database and database user (role) for Galaxy to use.</p>

<p>The <em>db-setup.sql</em> script does three things</p>

<ol>
  <li>Create a database named <strong>galaxy</strong></li>
  <li>Create a user (role) also named <strong>galaxy</strong></li>
  <li>Make the <strong>galaxy</strong> user the owner of the <strong>galaxy</strong> database.</li>
</ol>

<p>Before running the script we will also have to replace the <em>__DB_PASSWORD__</em> string just as we did for the <em>galaxy.ini</em> file.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$&gt; </span>curl -sSL http://downloads.lappsgrid.org/scripts/db-setup.sql | sed <span class="s2">"s/__DB_PASSWORD__/</span><span class="nv">$PASSWORD</span><span class="s2">/"</span> | sudo -u postgres psql
</code></pre>
</div>

<h3 id="starting-galaxy">Starting Galaxy</h3>

<p>For the purposes of this example we will launch galaxy using the <em>run.sh</em> script in the root galaxy directory.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$&gt; </span>chown -R galaxy:galaxy /home/galaxy
<span class="gp">$&gt; </span><span class="nb">cd</span> /home/galaxy/galaxy
<span class="gp">$&gt; </span><span class="nv">HOME</span><span class="o">=</span>/home/galaxy sudo -u galaxy ./run.sh
</code></pre>
</div>

<h1 id="todo">TODO</h1>

<ol>
  <li>Explain installing and using <strong>supervisord</strong> to run Galaxy as a proper service.</li>
</ol>


	
      </section>
    </div>
	<div>
	</div>
    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p>Copyright &copy; 2017 The Language Application Grid</p>
      </footer>
    </div>

    

  </body>
</html>


